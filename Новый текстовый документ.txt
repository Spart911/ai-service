
# -*- coding: utf-8 -*-
from natasha import (
    Segmenter,
    MorphVocab,
    NewsEmbedding,
    NewsMorphTagger,
    NewsSyntaxParser,
    NewsNERTagger,
    PER,
    NamesExtractor,
    Doc, LOC
)
import re
from PIL import Image, ImageDraw
import easyocr


def is_valid_home_format(home_string):
    # Регулярное выражение для формата "д.178/1"
    date_pattern = re.compile(r'\b(?:д|кв)\.\d+(?:/\d+)?\b', flags=re.IGNORECASE)

    return bool(date_pattern.match(home_string))

def is_valid_date_format(date_string):
    date_pattern = re.compile(r'\b\d{2}.\d{2}.\d{4}(г\.)?\b|\b\d{2}.\d{2}.\d{4}')

    return bool(date_pattern.match(date_string))
def is_valid_cost_format(cost_string):
    cost_pattern = re.compile(r'\b\d+(?:р\.|р)\b')

    return bool(cost_pattern.match(cost_string))
def read_string_from_file(file_path):
    try:
        with open(file_path, 'r', encoding='utf-8') as file:
            content = file.read()
            print(f"Строка успешно прочитана из файла: {file_path}")
            return content
    except Exception as e:
        print(f"Ошибка при чтении строки из файла: {e}")
        return None

def read_and_create_list(file_path):
    with open(file_path, 'r', encoding='utf-8') as file:
        content = file.read()

    # Убираем скобки и разделяем текст на слова
    words = [word.strip('[],') for word in content.split()]

    # Удаляем повторяющиеся слова
    unique_words = list(set(words))

    return unique_words
def remove_duplicates(list1, list2):
    unique_list1 = list(set(list1) - set(list2))
    return unique_list1
def save_string_to_file(file_path, content):
    try:
        with open(file_path, 'w', encoding='utf-8') as file:
            file.write(content)
        print(f"Строка успешно сохранена в файл: {file_path}")
    except Exception as e:
        print(f"Ошибка при сохранении строки в файл: {e}")
def replace_numbers_with_asterisks(my_list):
    result_list = []
    chek_ot = 0
    chek_front_ot_zak = 0
    chek_front_ot_fz = 0
    chek_cite_street = 0
    chek_state= 0
    for item in my_list:
        if chek_state == 0 and "." not in item  and "ФЗ"  not in item or (is_valid_date_format(item) and chek_ot == 0) or is_valid_home_format(item) or is_valid_cost_format(item):
            modified_item = ''.join('*' if c.isdigit() & c.isdigit() else c for c in item)
            if chek_cite_street == 1:
                modified_item = "*****"
            result_list.append(modified_item)
        else:
            if "@"  in item or "https://"  in item:
                modified_item = "*****"
                result_list.append(modified_item)
            else:
                result_list.append(item)
        if (item == "от" and chek_front_ot_zak == 1) or (item == "от" and chek_front_ot_fz == 1):
            chek_ot = 1
        else:
            chek_ot = 0

        if item == "ул." or item == "г." or item == "г.о." :
            chek_cite_street = 1
        else:
            chek_cite_street = 0



        if item ==  "ст." or item ==  "(ст.":
            chek_state = 1
        else:
            chek_state = 0



        if (item == "от" and chek_front_ot_zak == 1) or (item == "от" and chek_front_ot_fz == 1):
            chek_ot = 1
        else:
            chek_ot = 0
        if item == "закона":
            chek_front_ot_zak = 1
            chek_front_ot_fz = 0
        else:
            chek_front_ot_zak = 0

        if item == "ФЗ":
            chek_front_ot_fz = 1
            chek_front_ot_zak = 0
        else:
            chek_front_ot_fz = 0
    return result_list
def replace_elements_with_asterisks(list1, list2):
    for i in range(len(list1)):
        for element in list2:
            if element in list1[i]:
                list1[i] = list1[i].replace(element, '******')
def create_rectangles(image_path, words_to_hide, extracted_text, ListCoordinate):
    # words_to_hide - то что вычесть
    # extracted_text - откуда вычесть
    img = Image.open(image_path)
    draw = ImageDraw.Draw(img)

    for i, detection in enumerate(extracted_text):
        word = detection
        print(word)
        if i < len(ListCoordinate):
            coordinates = ListCoordinate[i]

            # Проверка на корректность координат
            if len(coordinates) == 4:  # убедитесь, что координаты представляют собой четыре точки (x0, y0, x1, y1)
                x0, y0 = coordinates[0]
                x1, y1 = coordinates[2]
                # Проверка на корректность границ
                if y1 >= y0:
                    # Рисование прямоугольника
                    draw.rectangle([x0, y0, x1, y1], fill="black")
                else:
                    print("Ошибка: y1 должно быть больше или равно y0")
            else:
                print("Ошибка: Некорректные координаты")
        else:
            print("Ошибка: Недостаточно координат для всех слов")

        # Save the image with hidden words
        img.save("output_image.jpg")


def extract_text_from_image(image_path, List, ListCoordinate, languages=['en','ru']):
    # Initialize the EasyOCR Reader with the selected languages
    reader = easyocr.Reader(languages)

    # Get the result of text recognition
    result = reader.readtext(image_path)
    for detection in result:
        List.append(detection[1])
        ListCoordinate.append(detection[0])
    return result

    return extracted_text
# Press the green button in the gutter to run the script.
if __name__ == '__main__':
    ListCoordinate = []
    file_path = 'text_file.txt'
    # Path to the image
    image_path = 'test.jpg'
    file_path_exeption = 'exeption.txt'
    List = []
    ListMonth = ["января", "февраля", "марта", "апреля", "мая", "июня", "июля", "августа", "сентября", "октября", "ноября", "декабря"]
    ListExeption = read_and_create_list(file_path_exeption)
    index = 0
    extract_text_from_image(image_path, List, ListCoordinate)
    print(List)




    segmenter = Segmenter()
    morph_vocab = MorphVocab()
    emb = NewsEmbedding()

    morph_tagger = NewsMorphTagger(emb)
    syntax_parser = NewsSyntaxParser(emb)
    ner_tagger = NewsNERTagger(emb)

    names_extractor = NamesExtractor(morph_vocab)

    # text_first = read_string_from_file(file_path)
    # text_second = text_first.split()
    modified_list = replace_numbers_with_asterisks(List)
    text = ", ".join(modified_list)
    doc = Doc(text)
    doc.segment(segmenter)
    doc.tag_morph(morph_tagger)
    doc.parse_syntax(syntax_parser)
    doc.tag_ner(ner_tagger)
    for span in doc.spans:
        if span.type == PER:
            List.append(span.text)
            print("Персонаж: ",span.text)
        if span.type == LOC:
            List.append(span.text)
            print("Адрес: ",span.text)

    result_list = remove_duplicates(List, ListExeption)
    result_list.append(ListMonth)
    text_end = " ".join(str(item) for item in result_list)
    save_string_to_file("text_del.txt", text_end)

    create_rectangles(image_path, result_list, modified_list, ListCoordinate)

    # print(modified_list)
    # replace_elements_with_asterisks(modified_list, result_list)
    # print(modified_list)
    # text_end = " ".join(modified_list)
    # save_string_to_file(file_path, text_end)








